# ONNX (Open Neural Network Exchange) Model File Header
# Specification: ONNX Format Specification
# Platform: Cross-platform - AI/ML model interchange format
# Purpose: Parsing ONNX model files (.onnx)
#
# ONNX is a Protocol Buffers-based format for neural network models.
# It allows models to be transferred between different ML frameworks
# (PyTorch, TensorFlow, etc.). Files use Protobuf serialization.
#
# The file structure is a serialized ModelProto message in Protobuf format.
# This template captures the initial bytes to identify ONNX files.
#
# Usage: Model files exported from PyTorch, TensorFlow, etc.
# Reference: https://github.com/onnx/onnx/blob/main/docs/IR.md
# See also: onnx Python library, Netron model visualizer

name: ONNX Model File Header
description: |
  ONNX model file identification header. ONNX uses Protocol Buffers
  serialization, so the file doesn't have a fixed magic number like
  other formats. Instead, it starts with Protobuf wire format bytes.
  This template identifies ONNX files by their Protobuf structure.
endian: little  # Protobuf uses little-endian varints

fields:
  - name: protobuf_field_1_tag
    offset: 0x00
    size: 1
    type: u8
    description: "Protobuf field tag for ir_version (field 1, varint)"
    # Protobuf wire format: (field_number << 3) | wire_type
    # Field 1, wire type 0 (varint) = 0x08
    # This is almost always the first byte in an ONNX file
    assert: "08"
    
  - name: ir_version
    offset: 0x01
    size: 1
    type: u8
    description: "ONNX IR (Intermediate Representation) version number"
    enum:
      3: "IR version 3 (ONNX 1.0-1.1)"
      4: "IR version 4 (ONNX 1.2-1.3)"
      5: "IR version 5 (ONNX 1.4-1.5)"
      6: "IR version 6 (ONNX 1.6-1.7)"
      7: "IR version 7 (ONNX 1.8-1.10)"
      8: "IR version 8 (ONNX 1.11+)"
      9: "IR version 9 (ONNX 1.13+)"
    # IR version determines which operators and features are available
    
  - name: protobuf_field_7_tag
    offset: 0x02
    size: 1
    type: u8
    description: "Protobuf field tag for graph (field 7, length-delimited)"
    # Field 7, wire type 2 (length-delimited) = 0x3A
    # The graph field contains the actual model computation graph
    
  - name: graph_length_varint_start
    offset: 0x03
    size: 1
    type: u8
    description: "Start of varint encoding for graph message length"
    # This byte (and potentially following bytes) encode the length
    # of the graph message in Protobuf varint format
    # Varints use bit 7 as continuation bit:
    #   if bit 7 = 1, more bytes follow
    #   if bit 7 = 0, this is the last byte
    # Lower 7 bits of each byte form the actual value

# Note: ONNX files don't have a traditional fixed header structure
# because they use Protocol Buffers serialization. The above fields
# represent the typical start of an ONNX model file, but the actual
# structure is defined by the ModelProto Protobuf message.
#
# Full ONNX ModelProto structure (simplified):
#   int64 ir_version                    (field 1)
#   repeated opset_import opset_import  (field 8)
#   string producer_name                (field 2)
#   string producer_version             (field 3)
#   string domain                       (field 4)
#   int64 model_version                 (field 5)
#   string doc_string                   (field 6)
#   GraphProto graph                    (field 7) - main computation graph
#   repeated StringStringEntryProto metadata_props (field 14)
#
# To fully parse ONNX files, use a Protobuf library with the ONNX schema.
# For file identification, checking the first few bytes is sufficient.
