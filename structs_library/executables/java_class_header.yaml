# Java Class File Format Header
# Specification: The Java Virtual Machine Specification (JVMS)
# Platform: JVM - all platforms
# Purpose: Parsing compiled Java .class files
#
# Java class files contain bytecode compiled from Java source code.
# They are platform-independent and executed by the JVM.
# Format includes magic number, version, constant pool, and class metadata.
#
# Usage: Every .class file in a JAR or on filesystem
# Reference: https://docs.oracle.com/javase/specs/jvms/se17/html/jvms-4.html
# See also: javap, jd-gui, cfr

name: Java Class File Header
description: |
  Java class file format header containing magic number, version numbers,
  and constant pool count. Essential for Java bytecode analysis and
  reverse engineering. Full class structure follows the constant pool.
endian: big  # Java class files are always big-endian

fields:
  - name: magic
    offset: 0x00
    size: 4
    type: hex_string
    description: "Java class file magic number"
    assert: "cafebabe"
    # 0xCAFEBABE - all Java class files start with this
    
  - name: minor_version
    offset: 0x04
    size: 2
    type: u16
    description: "Minor version number (usually 0)"
    # Rarely used; typically 0 for most Java versions
    
  - name: major_version
    offset: 0x06
    size: 2
    type: u16
    description: "Major version number (determines Java version)"
    enum:
      45: "Java 1.1"
      46: "Java 1.2"
      47: "Java 1.3"
      48: "Java 1.4"
      49: "Java 5"
      50: "Java 6"
      51: "Java 7"
      52: "Java 8"
      53: "Java 9"
      54: "Java 10"
      55: "Java 11"
      56: "Java 12"
      57: "Java 13"
      58: "Java 14"
      59: "Java 15"
      60: "Java 16"
      61: "Java 17"
      62: "Java 18"
      63: "Java 19"
      64: "Java 20"
      65: "Java 21"
    # Version = major.minor (e.g., 52.0 = Java 8)
    
  - name: constant_pool_count
    offset: 0x08
    size: 2
    type: u16
    description: "Number of entries in constant pool + 1"
    # Constant pool contains literals, class names, field names, etc.
    # Actual count is constant_pool_count - 1 (index 0 is reserved)
    # Constant pool immediately follows this field

# After constant_pool_count, the variable-length constant pool follows
# Each entry has a tag byte indicating its type, then type-specific data
# Constant pool tags:
#   1: CONSTANT_Utf8 (modified UTF-8 string)
#   3: CONSTANT_Integer
#   4: CONSTANT_Float
#   5: CONSTANT_Long (takes 2 slots)
#   6: CONSTANT_Double (takes 2 slots)
#   7: CONSTANT_Class (reference to Utf8 with class name)
#   8: CONSTANT_String (reference to Utf8 with string value)
#   9: CONSTANT_Fieldref
#   10: CONSTANT_Methodref
#   11: CONSTANT_InterfaceMethodref
#   12: CONSTANT_NameAndType
#   15: CONSTANT_MethodHandle (Java 7+)
#   16: CONSTANT_MethodType (Java 7+)
#   17: CONSTANT_Dynamic (Java 11+)
#   18: CONSTANT_InvokeDynamic (Java 7+)
#   19: CONSTANT_Module (Java 9+)
#   20: CONSTANT_Package (Java 9+)
#
# After constant pool, class file continues with:
#   u16 access_flags (public, final, abstract, etc.)
#   u16 this_class (index into constant pool)
#   u16 super_class (index into constant pool)
#   u16 interfaces_count
#   u16[interfaces_count] interfaces
#   u16 fields_count
#   field_info[fields_count] fields
#   u16 methods_count
#   method_info[methods_count] methods
#   u16 attributes_count
#   attribute_info[attributes_count] attributes
