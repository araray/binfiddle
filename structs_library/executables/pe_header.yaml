# PE (Portable Executable) Header - Windows Executables
# Specification: Microsoft PE and COFF Specification
# Platform: Windows (all versions)
# Purpose: Parsing DOS stub, PE signature, COFF header, and Optional Header
#
# This template parses the PE header structure used by Windows .exe, .dll, .sys files.
# PE files start with a DOS stub (for backwards compatibility) followed by the actual PE header.
#
# Reference: https://learn.microsoft.com/en-us/windows/win32/debug/pe-format
# File types: .exe (executables), .dll (libraries), .sys (drivers), .efi (UEFI)

name: PE (Portable Executable) Header
description: |
  Complete Windows PE/COFF header including DOS stub, PE signature, COFF header,
  and PE32+ Optional Header (64-bit). Supports executables, DLLs, and drivers.
endian: little  # PE format is always little-endian

fields:
  # ============================================================================
  # DOS Header (IMAGE_DOS_HEADER) - 64 bytes
  # Legacy compatibility stub that prints "This program cannot be run in DOS mode"
  # ============================================================================
  
  - name: e_magic
    offset: 0x00
    size: 2
    type: hex_string
    description: "DOS signature: 'MZ' (Mark Zbikowski's initials)"
    assert: "4d5a"
    
  - name: e_cblp
    offset: 0x02
    size: 2
    type: u16
    description: "Bytes on last page of file"
    
  - name: e_cp
    offset: 0x04
    size: 2
    type: u16
    description: "Pages in file"
    
  - name: e_crlc
    offset: 0x06
    size: 2
    type: u16
    description: "Relocations"
    
  - name: e_cparhdr
    offset: 0x08
    size: 2
    type: u16
    description: "Size of header in paragraphs (16-byte units)"
    
  - name: e_minalloc
    offset: 0x0A
    size: 2
    type: u16
    description: "Minimum extra paragraphs needed"
    
  - name: e_maxalloc
    offset: 0x0C
    size: 2
    type: u16
    description: "Maximum extra paragraphs needed"
    
  - name: e_ss
    offset: 0x0E
    size: 2
    type: u16
    description: "Initial (relative) SS value"
    display: hex
    
  - name: e_sp
    offset: 0x10
    size: 2
    type: u16
    description: "Initial SP value"
    display: hex
    
  - name: e_csum
    offset: 0x12
    size: 2
    type: u16
    description: "Checksum (usually ignored)"
    display: hex
    
  - name: e_ip
    offset: 0x14
    size: 2
    type: u16
    description: "Initial IP value"
    display: hex
    
  - name: e_cs
    offset: 0x16
    size: 2
    type: u16
    description: "Initial (relative) CS value"
    display: hex
    
  - name: e_lfarlc
    offset: 0x18
    size: 2
    type: u16
    description: "File address of relocation table"
    display: hex
    
  - name: e_ovno
    offset: 0x1A
    size: 2
    type: u16
    description: "Overlay number"
    
  - name: e_res
    offset: 0x1C
    size: 8
    type: hex_string
    description: "Reserved words"
    
  - name: e_oemid
    offset: 0x24
    size: 2
    type: u16
    description: "OEM identifier (for e_oeminfo)"
    
  - name: e_oeminfo
    offset: 0x26
    size: 2
    type: u16
    description: "OEM information; e_oemid specific"
    
  - name: e_res2
    offset: 0x28
    size: 20
    type: hex_string
    description: "Reserved words"
    
  - name: e_lfanew
    offset: 0x3C
    size: 4
    type: u32
    description: "File offset to PE header (usually 0x80 or 0x100)"
    display: hex

  # ============================================================================
  # PE Signature - 4 bytes at offset e_lfanew
  # NOTE: The following fields assume e_lfanew = 0x80 (common case)
  # For actual parsing, you'd need to follow e_lfanew
  # ============================================================================

  - name: pe_signature
    offset: 0x80
    size: 4
    type: hex_string
    description: "PE signature: 'PE\\0\\0' (0x50450000)"
    assert: "50450000"

  # ============================================================================
  # COFF File Header (IMAGE_FILE_HEADER) - 20 bytes
  # ============================================================================

  - name: machine
    offset: 0x84
    size: 2
    type: u16
    description: "Target machine architecture"
    enum:
      0: "IMAGE_FILE_MACHINE_UNKNOWN"
      332: "IMAGE_FILE_MACHINE_I386 (x86)"
      358: "IMAGE_FILE_MACHINE_R3000 (MIPS little-endian)"
      361: "IMAGE_FILE_MACHINE_R4000 (MIPS little-endian)"
      362: "IMAGE_FILE_MACHINE_R10000 (MIPS little-endian)"
      388: "IMAGE_FILE_MACHINE_ALPHA (Alpha AXP)"
      418: "IMAGE_FILE_MACHINE_SH3 (Hitachi SH3)"
      422: "IMAGE_FILE_MACHINE_SH4 (Hitachi SH4)"
      448: "IMAGE_FILE_MACHINE_ARM (ARM little-endian)"
      450: "IMAGE_FILE_MACHINE_THUMB (ARM Thumb)"
      452: "IMAGE_FILE_MACHINE_ARMNT (ARM Thumb-2)"
      467: "IMAGE_FILE_MACHINE_AM33 (Matsushita AM33)"
      496: "IMAGE_FILE_MACHINE_POWERPC (PowerPC little-endian)"
      497: "IMAGE_FILE_MACHINE_POWERPCFP (PowerPC with FPU)"
      512: "IMAGE_FILE_MACHINE_IA64 (Intel Itanium)"
      614: "IMAGE_FILE_MACHINE_MIPS16 (MIPS16)"
      644: "IMAGE_FILE_MACHINE_ALPHA64 (Alpha 64-bit)"
      870: "IMAGE_FILE_MACHINE_MIPSFPU (MIPS with FPU)"
      1104: "IMAGE_FILE_MACHINE_TRICORE (Infineon)"
      3311: "IMAGE_FILE_MACHINE_CEF (CEF)"
      4132: "IMAGE_FILE_MACHINE_EBC (EFI Byte Code)"
      34404: "IMAGE_FILE_MACHINE_AMD64 (x64 / x86-64)"
      36929: "IMAGE_FILE_MACHINE_M32R (Mitsubishi M32R)"
      43620: "IMAGE_FILE_MACHINE_ARM64 (ARM64 / AArch64)"
      60000: "IMAGE_FILE_MACHINE_CEE (CEE)"

  - name: number_of_sections
    offset: 0x86
    size: 2
    type: u16
    description: "Number of section headers (max 96 typical, 65535 theoretical)"

  - name: time_date_stamp
    offset: 0x88
    size: 4
    type: u32
    description: "Unix timestamp of when the file was created (seconds since 1970-01-01)"
    display: hex

  - name: pointer_to_symbol_table
    offset: 0x8C
    size: 4
    type: u32
    description: "File offset of COFF symbol table (deprecated, usually 0)"
    display: hex

  - name: number_of_symbols
    offset: 0x90
    size: 4
    type: u32
    description: "Number of COFF symbols (deprecated, usually 0)"

  - name: size_of_optional_header
    offset: 0x94
    size: 2
    type: u16
    description: "Size of optional header (224 for PE32, 240 for PE32+)"

  - name: characteristics
    offset: 0x96
    size: 2
    type: u16
    description: "File characteristics flags (bitfield)"
    display: hex
    # Flags: 0x0001=RELOCS_STRIPPED, 0x0002=EXECUTABLE_IMAGE, 0x0004=LINE_NUMS_STRIPPED
    #        0x0008=LOCAL_SYMS_STRIPPED, 0x0010=AGGRESSIVE_WS_TRIM, 0x0020=LARGE_ADDRESS_AWARE
    #        0x0080=BYTES_REVERSED_LO, 0x0100=32BIT_MACHINE, 0x0200=DEBUG_STRIPPED
    #        0x0400=REMOVABLE_RUN_FROM_SWAP, 0x0800=NET_RUN_FROM_SWAP, 0x1000=SYSTEM
    #        0x2000=DLL, 0x4000=UP_SYSTEM_ONLY, 0x8000=BYTES_REVERSED_HI

  # ============================================================================
  # Optional Header (IMAGE_OPTIONAL_HEADER64) - PE32+ (64-bit)
  # Size: 240 bytes for PE32+, 224 bytes for PE32
  # ============================================================================

  - name: magic
    offset: 0x98
    size: 2
    type: u16
    description: "Optional header magic number"
    enum:
      267: "IMAGE_NT_OPTIONAL_HDR32_MAGIC (PE32)"
      523: "IMAGE_NT_OPTIONAL_HDR64_MAGIC (PE32+)"
      
  - name: major_linker_version
    offset: 0x9A
    size: 1
    type: u8
    description: "Linker major version number"
    
  - name: minor_linker_version
    offset: 0x9B
    size: 1
    type: u8
    description: "Linker minor version number"
    
  - name: size_of_code
    offset: 0x9C
    size: 4
    type: u32
    description: "Sum of sizes of all code sections (.text)"
    display: hex
    
  - name: size_of_initialized_data
    offset: 0xA0
    size: 4
    type: u32
    description: "Sum of sizes of all initialized data sections"
    display: hex
    
  - name: size_of_uninitialized_data
    offset: 0xA4
    size: 4
    type: u32
    description: "Sum of sizes of all uninitialized data sections (.bss)"
    display: hex
    
  - name: address_of_entry_point
    offset: 0xA8
    size: 4
    type: u32
    description: "RVA of entry point function (relative to image base)"
    display: hex
    
  - name: base_of_code
    offset: 0xAC
    size: 4
    type: u32
    description: "RVA of start of code section"
    display: hex

  # PE32+ (64-bit) continues here; PE32 has base_of_data here instead

  - name: image_base
    offset: 0xB0
    size: 8
    type: u64
    description: "Preferred load address (0x140000000 typical for x64 EXE)"
    display: hex
    
  - name: section_alignment
    offset: 0xB8
    size: 4
    type: u32
    description: "Section alignment in memory (typically 0x1000 = 4KB page)"
    display: hex
    
  - name: file_alignment
    offset: 0xBC
    size: 4
    type: u32
    description: "Section alignment in file (typically 0x200 = 512 bytes)"
    display: hex
    
  - name: major_os_version
    offset: 0xC0
    size: 2
    type: u16
    description: "Minimum required OS major version"
    
  - name: minor_os_version
    offset: 0xC2
    size: 2
    type: u16
    description: "Minimum required OS minor version"
    
  - name: major_image_version
    offset: 0xC4
    size: 2
    type: u16
    description: "Major version of the image"
    
  - name: minor_image_version
    offset: 0xC6
    size: 2
    type: u16
    description: "Minor version of the image"
    
  - name: major_subsystem_version
    offset: 0xC8
    size: 2
    type: u16
    description: "Major subsystem version"
    
  - name: minor_subsystem_version
    offset: 0xCA
    size: 2
    type: u16
    description: "Minor subsystem version"
    
  - name: win32_version_value
    offset: 0xCC
    size: 4
    type: u32
    description: "Reserved, must be 0"
    assert: "00000000"
    
  - name: size_of_image
    offset: 0xD0
    size: 4
    type: u32
    description: "Total size of image in memory (must be multiple of SectionAlignment)"
    display: hex
    
  - name: size_of_headers
    offset: 0xD4
    size: 4
    type: u32
    description: "Combined size of DOS stub, PE header, and section headers"
    display: hex
    
  - name: checksum
    offset: 0xD8
    size: 4
    type: u32
    description: "Image checksum (validated for drivers and system DLLs)"
    display: hex
    
  - name: subsystem
    offset: 0xDC
    size: 2
    type: u16
    description: "Windows subsystem required to run this image"
    enum:
      0: "IMAGE_SUBSYSTEM_UNKNOWN"
      1: "IMAGE_SUBSYSTEM_NATIVE (Device driver / native system process)"
      2: "IMAGE_SUBSYSTEM_WINDOWS_GUI (GUI application)"
      3: "IMAGE_SUBSYSTEM_WINDOWS_CUI (Console application)"
      5: "IMAGE_SUBSYSTEM_OS2_CUI (OS/2 console)"
      7: "IMAGE_SUBSYSTEM_POSIX_CUI (POSIX console)"
      9: "IMAGE_SUBSYSTEM_WINDOWS_CE_GUI (Windows CE)"
      10: "IMAGE_SUBSYSTEM_EFI_APPLICATION (EFI application)"
      11: "IMAGE_SUBSYSTEM_EFI_BOOT_SERVICE_DRIVER (EFI boot service driver)"
      12: "IMAGE_SUBSYSTEM_EFI_RUNTIME_DRIVER (EFI runtime driver)"
      13: "IMAGE_SUBSYSTEM_EFI_ROM (EFI ROM image)"
      14: "IMAGE_SUBSYSTEM_XBOX (Xbox system)"
      16: "IMAGE_SUBSYSTEM_WINDOWS_BOOT_APPLICATION (Boot application)"
      
  - name: dll_characteristics
    offset: 0xDE
    size: 2
    type: u16
    description: "DLL characteristics flags (security features)"
    display: hex
    # Flags: 0x0020=HIGH_ENTROPY_VA, 0x0040=DYNAMIC_BASE (ASLR), 0x0080=FORCE_INTEGRITY
    #        0x0100=NX_COMPAT (DEP), 0x0200=NO_ISOLATION, 0x0400=NO_SEH, 0x0800=NO_BIND
    #        0x1000=APPCONTAINER, 0x2000=WDM_DRIVER, 0x4000=GUARD_CF, 0x8000=TERMINAL_SERVER_AWARE
    
  - name: size_of_stack_reserve
    offset: 0xE0
    size: 8
    type: u64
    description: "Size of stack to reserve (virtual memory)"
    display: hex
    
  - name: size_of_stack_commit
    offset: 0xE8
    size: 8
    type: u64
    description: "Size of stack to commit (physical memory initially)"
    display: hex
    
  - name: size_of_heap_reserve
    offset: 0xF0
    size: 8
    type: u64
    description: "Size of heap to reserve"
    display: hex
    
  - name: size_of_heap_commit
    offset: 0xF8
    size: 8
    type: u64
    description: "Size of heap to commit initially"
    display: hex
    
  - name: loader_flags
    offset: 0x100
    size: 4
    type: u32
    description: "Obsolete, reserved, must be 0"
    assert: "00000000"
    
  - name: number_of_rva_and_sizes
    offset: 0x104
    size: 4
    type: u32
    description: "Number of data directory entries (usually 16)"
    
  # Data Directories start at 0x108 (16 entries, each 8 bytes = 128 bytes total)
  # Each entry: RVA (4 bytes) + Size (4 bytes)
  # Common directories: Export, Import, Resource, Exception, Certificate, Base Relocation,
  #                     Debug, Architecture, Global Ptr, TLS, Load Config, Bound Import,
  #                     IAT, Delay Import, CLR Runtime Header, Reserved
