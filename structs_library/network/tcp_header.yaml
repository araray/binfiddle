# TCP (Transmission Control Protocol) Segment Header
# Specification: RFC 793 - Transmission Control Protocol
# Purpose: Parsing TCP segment header for network protocol analysis
#
# TCP provides reliable, ordered, error-checked delivery of byte streams.
# Header size: 20-60 bytes (20 bytes without options)
#
# Reference: https://datatracker.ietf.org/doc/html/rfc793
# Layer: OSI Layer 4 (Transport)

name: TCP Segment Header
description: |
  TCP segment header with ports, sequence numbers, flags, window size,
  and checksum. Minimum 20 bytes, up to 60 bytes with options.
endian: big  # Network byte order (big-endian)

fields:
  # ============================================================================
  # TCP Header - 20 bytes minimum (without options)
  # ============================================================================
  
  - name: source_port
    offset: 0x00
    size: 2
    type: u16
    description: "Source port number (0-65535)"
    # Well-known ports (0-1023):
    #   20/21 = FTP, 22 = SSH, 23 = Telnet, 25 = SMTP, 53 = DNS
    #   80 = HTTP, 110 = POP3, 143 = IMAP, 443 = HTTPS, 3389 = RDP
    # Registered ports (1024-49151)
    # Dynamic/Private ports (49152-65535)
    
  - name: destination_port
    offset: 0x02
    size: 2
    type: u16
    description: "Destination port number (0-65535)"
    
  - name: sequence_number
    offset: 0x04
    size: 4
    type: u32
    description: "Sequence number (byte position in stream)"
    display: hex
    # Initial sequence number (ISN) chosen randomly during handshake
    # Increments by number of bytes sent
    # Wraps around at 2^32 (4,294,967,296)
    
  - name: acknowledgment_number
    offset: 0x08
    size: 4
    type: u32
    description: "Acknowledgment number (next expected byte from peer)"
    display: hex
    # Only meaningful if ACK flag is set
    # Acknowledges all bytes up to (but not including) this number
    
  - name: data_offset_and_reserved
    offset: 0x0C
    size: 1
    type: u8
    description: "Data Offset (4 bits) + Reserved (3 bits) + NS flag (1 bit)"
    display: hex
    # Bits 7-4: Data Offset (header length in 32-bit words)
    #           Minimum: 5 (20 bytes), Maximum: 15 (60 bytes)
    # Bits 3-1: Reserved (must be 0)
    # Bit 0: NS (ECN-nonce concealment protection)
    
  - name: flags
    offset: 0x0D
    size: 1
    type: u8
    description: "TCP control flags (8 bits)"
    display: hex
    # Bit 7: CWR (Congestion Window Reduced)
    # Bit 6: ECE (ECN-Echo)
    # Bit 5: URG (Urgent pointer field significant)
    # Bit 4: ACK (Acknowledgment field significant)
    # Bit 3: PSH (Push function - deliver immediately)
    # Bit 2: RST (Reset connection)
    # Bit 1: SYN (Synchronize sequence numbers - connection setup)
    # Bit 0: FIN (No more data from sender - connection teardown)
    enum:
      2: "SYN - Connection initiation"
      18: "SYN-ACK - Connection acknowledgment"
      16: "ACK - Data acknowledgment"
      17: "FIN-ACK - Connection close"
      4: "RST - Connection reset"
      24: "PSH-ACK - Push data"
    
  - name: window_size
    offset: 0x0E
    size: 2
    type: u16
    description: "Window size (bytes sender is willing to receive)"
    # Flow control mechanism - receiver advertises available buffer space
    # Can be scaled up to ~1GB using Window Scale option (RFC 7323)
    
  - name: checksum
    offset: 0x10
    size: 2
    type: u16
    description: "Checksum (one's complement of header + data + pseudo-header)"
    display: hex
    # Pseudo-header includes: Source IP, Dest IP, Protocol (6), TCP Length
    # Protects against misrouted packets
    
  - name: urgent_pointer
    offset: 0x12
    size: 2
    type: u16
    description: "Urgent pointer (offset to urgent data, if URG flag set)"
    display: hex
    # Rarely used, points to last byte of urgent data

  # ============================================================================
  # Options Field - Variable length (0-40 bytes)
  # Present if Data Offset > 5 (header length > 20 bytes)
  # Offset: 0x14
  # ============================================================================

  # Options format (each option):
  #   Kind (1 byte): Option type
  #   Length (1 byte, for variable-length options): Total option length
  #   Data (variable, depends on option)
  #
  # Common options:
  #   Kind 0: End of Option List (1 byte)
  #   Kind 1: No-Operation (NOP, padding, 1 byte)
  #   Kind 2: Maximum Segment Size (MSS, 4 bytes)
  #     Format: Kind(1) + Length(1) + MSS(2)
  #     Negotiates max TCP payload size (e.g., 1460 for Ethernet)
  #     Only sent in SYN packets
  #   Kind 3: Window Scale (3 bytes, RFC 7323)
  #     Format: Kind(1) + Length(1) + Shift(1)
  #     Multiplies window size by 2^Shift (max 2^14 = 16384x)
  #     Only sent in SYN packets
  #   Kind 4: SACK Permitted (2 bytes, RFC 2018)
  #     Allows Selective Acknowledgment
  #     Only sent in SYN packets
  #   Kind 5: SACK (variable, RFC 2018)
  #     Acknowledges non-contiguous blocks of data
  #     Format: Kind(1) + Length(1) + Blocks(variable)
  #     Each block: Left Edge(4) + Right Edge(4)
  #   Kind 8: Timestamps (10 bytes, RFC 7323)
  #     Format: Kind(1) + Length(1) + TSval(4) + TSecr(4)
  #     Used for RTT measurement and PAWS (Protection Against Wrapped Sequences)
  #   Kind 34: TCP Fast Open (variable, RFC 7413)
  #     Allows data in SYN packet
  #
  # Options are padded to 32-bit boundary with NOP (Kind 1)

  # ============================================================================
  # Payload - Variable length
  # Offset: 20 + (options_length) bytes
  # ============================================================================

  # Application data (HTTP request, SSH traffic, etc.)
  # Maximum Segment Size (MSS) limits payload size
  # Typical MSS: 1460 bytes (1500 MTU - 20 IP header - 20 TCP header)

  # ============================================================================
  # TCP Connection Lifecycle
  # ============================================================================

  # Three-Way Handshake (Connection Establishment):
  #   Client -> Server: SYN (SEQ=x)
  #   Server -> Client: SYN-ACK (SEQ=y, ACK=x+1)
  #   Client -> Server: ACK (SEQ=x+1, ACK=y+1)
  #
  # Data Transfer:
  #   Sender -> Receiver: PSH-ACK (SEQ=n, ACK=m, Data)
  #   Receiver -> Sender: ACK (SEQ=m, ACK=n+len)
  #
  # Four-Way Handshake (Connection Termination):
  #   Client -> Server: FIN-ACK (SEQ=x)
  #   Server -> Client: ACK (ACK=x+1)
  #   Server -> Client: FIN-ACK (SEQ=y)
  #   Client -> Server: ACK (ACK=y+1)
  #
  # Abrupt Termination:
  #   Either -> Other: RST (SEQ=x)

  # ============================================================================
  # TCP State Machine (simplified)
  # ============================================================================

  # CLOSED -> (active open) -> SYN-SENT -> (SYN-ACK) -> ESTABLISHED
  # CLOSED -> (passive open) -> LISTEN -> (SYN) -> SYN-RECEIVED -> (ACK) -> ESTABLISHED
  # ESTABLISHED -> (close) -> FIN-WAIT-1 -> (ACK) -> FIN-WAIT-2 -> (FIN) -> TIME-WAIT -> CLOSED
  # ESTABLISHED -> (FIN) -> CLOSE-WAIT -> (close) -> LAST-ACK -> (ACK) -> CLOSED

  # ============================================================================
  # Performance Features
  # ============================================================================

  # - Congestion Control: Slow Start, Congestion Avoidance, Fast Retransmit, Fast Recovery
  # - Flow Control: Sliding window protocol using Window Size field
  # - Reliability: Sequence numbers, Acknowledgments, Retransmission timeout (RTO)
  # - Ordering: Sequence numbers ensure in-order delivery
  # - Error Detection: Checksum covers header and data
